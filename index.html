<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Tap Game</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a202c; /* Dark background */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568; /* Grayish thumb */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096; /* Lighter gray on hover */
        }

        /* Inter font from Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
            color: #e2e8f0; /* Light text color */
        }

        /* Custom button styles */
        .btn-primary {
            background: linear-gradient(145deg, #4CAF50, #2E8B57); /* Green gradient */
            box-shadow: 0 4px 15px rgba(0, 255, 0, 0.3);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background: linear-gradient(145deg, #2E8B57, #4CAF50);
            box-shadow: 0 6px 20px rgba(0, 255, 0, 0.4);
            transform: translateY(-2px);
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0, 255, 0, 0.2);
        }

        .btn-secondary {
            background: linear-gradient(145deg, #4299E1, #3182CE); /* Blue gradient */
            box-shadow: 0 4px 15px rgba(66, 153, 225, 0.3);
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background: linear-gradient(145deg, #3182CE, #4299E1);
            box-shadow: 0 6px 20px rgba(66, 153, 225, 0.4);
            transform: translateY(-2px);
        }
        .btn-secondary:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(66, 153, 225, 0.2);
        }

        .btn-tertiary {
            background: linear-gradient(145deg, #ECC94B, #D69E2E); /* Yellow/Orange gradient */
            box-shadow: 0 4px 15px rgba(236, 201, 75, 0.3);
            transition: all 0.3s ease;
        }
        .btn-tertiary:hover {
            background: linear-gradient(145deg, #D69E2E, #ECC94B);
            box-shadow: 0 6px 20px rgba(236, 201, 75, 0.4);
            transform: translateY(-2px);
        }
        .btn-tertiary:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(236, 201, 75, 0.2);
        }

        /* Energy bar animation */
        .energy-bar-fill {
            transition: width 0.3s ease-out;
        }

        /* Message box animation */
        .message-box {
            animation: fadeInOut 3s forwards;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        /* Tap animation for coins */
        .coin-popup {
            position: absolute;
            font-size: 1.5rem;
            font-weight: bold;
            color: #FFD700; /* Gold color */
            pointer-events: none;
            animation: fadeUp 1s forwards;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.7);
        }

        @keyframes fadeUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-50px); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col items-center p-4">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-green-500 mx-auto"></div>
            <p class="mt-4 text-lg text-green-400">Loading Game...</p>
        </div>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="fixed top-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50 hidden">
        <p id="message-text"></p>
    </div>

    <!-- Telegram-only access message -->
    <div id="telegram-only-message" class="w-full max-w-md bg-gray-800 rounded-xl shadow-2xl p-6 flex flex-col items-center justify-center min-h-[400px] text-center hidden">
        <i class="fab fa-telegram-plane text-6xl text-blue-400 mb-4"></i>
        <h2 class="text-2xl font-bold text-yellow-400 mb-4">Game Access Restricted</h2>
        <p class="text-lg text-gray-300">This game can only be played through our official Telegram bot.</p>
        <p class="text-md text-gray-400 mt-2">Please open it via the bot's menu button.</p>
        <!-- You can add a link to your bot here if you know its full t.me link -->
        <!-- <a href="https://t.me/YourBotUsername" target="_blank" class="mt-6 btn-secondary py-3 px-6 rounded-xl font-bold text-lg">
            Go to Telegram Bot
        </a> -->
    </div>

    <!-- Main Game Container (Initially hidden) -->
    <div id="game-section" class="w-full max-w-md bg-gray-800 rounded-xl shadow-2xl p-6 flex flex-col items-center relative overflow-hidden hidden">
        <!-- User ID Display -->
        <div class="absolute top-4 left-4 text-xs text-gray-400">
            User ID: <span id="user-id-display" class="font-mono">Loading...</span>
        </div>

        <!-- Custom Logo Placeholder -->
        <div id="logo-container" class="mb-4">
            <!-- Replace this div with your own <img> tag or SVG for your logo -->
            <img src="https://placehold.co/120x40/0d1117/e2e8f0?text=YOUR_LOGO" alt="Your Logo" class="h-10 w-auto rounded-md">
        </div>

        <!-- Coins Display -->
        <div class="text-center mb-6">
            <h1 class="text-5xl font-extrabold text-yellow-400 flex items-center justify-center">
                <i class="fas fa-coins mr-3"></i> <span id="coins-display">0</span>
            </h1>
            <p class="text-md text-gray-400 mt-2">Total Coins</p>
        </div>

        <!-- Energy Bar -->
        <div class="w-full bg-gray-700 rounded-full h-4 mb-8 relative">
            <div id="energy-bar-fill" class="bg-gradient-to-r from-green-400 to-blue-500 h-full rounded-full energy-bar-fill" style="width: 100%;"></div>
            <span id="energy-display" class="absolute inset-0 flex items-center justify-center text-xs font-semibold text-white">1000 / 1000</span>
        </div>

        <!-- Tap Button -->
        <div id="tap-area" class="relative w-48 h-48 bg-gradient-to-br from-purple-600 to-indigo-800 rounded-full flex items-center justify-center cursor-pointer shadow-xl transform transition-transform duration-100 active:scale-95 mb-8 overflow-hidden">
            <div class="absolute inset-0 bg-black opacity-20 rounded-full blur-xl"></div>
            <i class="fas fa-dollar-sign text-7xl text-white animate-pulse"></i>
            <span class="absolute text-xl font-bold text-white bottom-4">Tap to Earn!</span>
        </div>

        <!-- Action Buttons -->
        <div class="grid grid-cols-3 gap-4 w-full mb-6">
            <button id="daily-reward-btn" class="btn-secondary py-3 px-4 rounded-xl font-bold text-lg flex items-center justify-center">
                <i class="fas fa-gift mr-2"></i> Daily
            </button>
            <button id="upgrades-btn" class="btn-tertiary py-3 px-4 rounded-xl font-bold text-lg flex items-center justify-center">
                <i class="fas fa-rocket mr-2"></i> Upgrades
            </button>
            <button id="mining-btn" class="btn-primary py-3 px-4 rounded-xl font-bold text-lg flex items-center justify-center">
                <i class="fas fa-hammer mr-2"></i> Mines
            </button>
        </div>

        <!-- Upgrades Section (Initially Hidden) -->
        <div id="upgrades-section" class="w-full hidden bg-gray-700 p-4 rounded-xl shadow-inner mt-4">
            <h2 class="text-2xl font-bold text-center mb-4 text-yellow-300">Boost Your Tapping!</h2>

            <!-- Tap Power Upgrade -->
            <div class="flex items-center justify-between bg-gray-800 p-4 rounded-lg mb-3 shadow-md">
                <div>
                    <h3 class="font-semibold text-lg text-green-400"><i class="fas fa-fist-raised mr-2"></i> Tap Power <span id="tap-power-level">(Lv. 0)</span></h3>
                    <p class="text-sm text-gray-300">Increase coins per tap by <span id="tap-power-increase">1</span></p>
                </div>
                <button id="upgrade-tap-power" class="btn-primary py-2 px-4 rounded-lg text-sm font-bold">
                    Buy (<span id="tap-power-cost">100</span> <i class="fas fa-coins"></i>)
                </button>
            </div>

            <!-- Energy Capacity Upgrade -->
            <div class="flex items-center justify-between bg-gray-800 p-4 rounded-lg mb-3 shadow-md">
                <div>
                    <h3 class="font-semibold text-lg text-blue-400"><i class="fas fa-battery-full mr-2"></i> Energy Capacity <span id="energy-capacity-level">(Lv. 0)</span></h3>
                    <p class="text-sm text-gray-300">Increase max energy by <span id="energy-capacity-increase">100</span></p>
                </div>
                <button id="upgrade-energy-capacity" class="btn-primary py-2 px-4 rounded-lg text-sm font-bold">
                    Buy (<span id="energy-capacity-cost">200</span> <i class="fas fa-coins"></i>)
                </button>
            </div>

            <!-- Energy Regeneration Upgrade -->
            <div class="flex items-center justify-between bg-gray-800 p-4 rounded-lg mb-3 shadow-md">
                <div>
                    <h3 class="font-semibold text-lg text-red-400"><i class="fas fa-charging-station mr-2"></i> Energy Regen <span id="energy-regen-level">(Lv. 0)</span></h3>
                    <p class="text-sm text-gray-300">Increase regen rate by <span id="energy-regen-increase">0.1</span>/sec</p>
                </div>
                <button id="upgrade-energy-regen" class="btn-primary py-2 px-4 rounded-lg text-sm font-bold">
                    Buy (<span id="energy-regen-cost">300</span> <i class="fas fa-coins"></i>)
                </button>
            </div>

            <button id="close-upgrades-btn" class="btn-secondary w-full py-3 px-4 rounded-xl font-bold text-lg mt-4">
                <i class="fas fa-arrow-left mr-2"></i> Back to Game
            </button>
        </div>

        <!-- Mining Section (Initially Hidden) -->
        <div id="mining-section" class="w-full hidden bg-gray-700 p-4 rounded-xl shadow-inner mt-4">
            <h2 class="text-2xl font-bold text-center mb-4 text-purple-300">Passive Income!</h2>

            <div class="flex justify-between items-center bg-gray-800 p-4 rounded-lg mb-4 shadow-md">
                <div>
                    <h3 class="font-semibold text-lg text-yellow-400"><i class="fas fa-clock mr-2"></i> Hourly Profit: <span id="hourly-profit-display">0</span> <i class="fas fa-coins"></i></h3>
                    <p class="text-sm text-gray-300">Accumulated: <span id="accumulated-profit-display">0</span> <i class="fas fa-coins"></i></p>
                </div>
                <button id="claim-profit-btn" class="btn-primary py-2 px-4 rounded-lg text-sm font-bold">
                    Claim All
                </button>
            </div>

            <div id="cards-list" class="space-y-3">
                <!-- Cards will be dynamically loaded here -->
            </div>

            <button id="close-mining-btn" class="btn-secondary w-full py-3 px-4 rounded-xl font-bold text-lg mt-4">
                <i class="fas fa-arrow-left mr-2"></i> Back to Game
            </button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Telegram Web Apps SDK
        if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            console.log("Telegram WebApp is ready!");
        } else {
            console.log("Not running inside Telegram WebApp.");
        }

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // UI Elements (Moved to top for early access)
        const loadingOverlay = document.getElementById('loading-overlay');
        const telegramOnlyMessage = document.getElementById('telegram-only-message');
        const gameSection = document.getElementById('game-section');
        const userIdDisplay = document.getElementById('user-id-display');
        const coinsDisplay = document.getElementById('coins-display');
        const energyDisplay = document.getElementById('energy-display');
        const energyBarFill = document.getElementById('energy-bar-fill');
        const tapArea = document.getElementById('tap-area');
        const dailyRewardBtn = document.getElementById('daily-reward-btn');
        const upgradesBtn = document.getElementById('upgrades-btn');
        const miningBtn = document.getElementById('mining-btn');
        const upgradesSection = document.getElementById('upgrades-section');
        const miningSection = document.getElementById('mining-section');
        const closeUpgradesBtn = document.getElementById('close-upgrades-btn');
        const closeMiningBtn = document.getElementById('close-mining-btn');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');

        // Upgrade UI elements
        const tapPowerLevel = document.getElementById('tap-power-level');
        const tapPowerIncrease = document.getElementById('tap-power-increase');
        const tapPowerCost = document.getElementById('tap-power-cost');
        const energyCapacityLevel = document.getElementById('energy-capacity-level');
        const energyCapacityIncrease = document.getElementById('energy-capacity-increase');
        const energyCapacityCost = document.getElementById('energy-capacity-cost');
        const energyRegenLevel = document.getElementById('energy-regen-level');
        const energyRegenIncrease = document.getElementById('energy-regen-increase');
        const energyRegenCost = document.getElementById('energy-regen-cost');
        const upgradeTapPowerBtn = document.getElementById('upgrade-tap-power');
        const upgradeEnergyCapacityBtn = document.getElementById('upgrade-energy-capacity');
        const upgradeEnergyRegenBtn = document.getElementById('upgrade-energy-regen');

        // Mining UI elements
        const hourlyProfitDisplay = document.getElementById('hourly-profit-display');
        const accumulatedProfitDisplay = document.getElementById('accumulated-profit-display');
        const claimProfitBtn = document.getElementById('claim-profit-btn');
        const cardsList = document.getElementById('cards-list');


        // Global variables for Firebase config and app ID
        const appId = typeof __app_id !== 'undefined' ? String(__app_id) : 'default-hamster-app-id';
        let firebaseConfig = {};
        try {
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? String(__firebase_config) : '{}');
            console.log("Firebase Config parsed:", firebaseConfig);
            // Explicitly check for projectId after parsing
            if (!firebaseConfig.projectId) {
                throw new Error("Firebase 'projectId' is missing in the configuration. Please ensure __firebase_config environment variable is correctly set.");
            }
        } catch (e) {
            console.error("Error processing __firebase_config:", e);
            loadingOverlay.classList.add('hidden');
            gameSection.classList.add('hidden');
            telegramOnlyMessage.classList.remove('hidden');
            document.getElementById('telegram-only-message').innerHTML = `
                <i class="fas fa-exclamation-triangle text-6xl text-red-400 mb-4"></i>
                <h2 class="text-2xl font-bold text-red-400 mb-4">Configuration Error</h2>
                <p class="text-lg text-gray-300">Firebase configuration is missing or invalid. Please check your Vercel environment variables (__firebase_config).</p>
                <p class="text-md text-gray-400 mt-2">Error: ${e.message}</p>
            `;
            throw e; // Stop further execution
        }


        // Initialize Firebase
        let app;
        let db;
        let auth;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            loadingOverlay.classList.add('hidden');
            gameSection.classList.add('hidden');
            telegramOnlyMessage.classList.remove('hidden');
            document.getElementById('telegram-only-message').innerHTML = `
                <i class="fas fa-exclamation-triangle text-6xl text-red-400 mb-4"></i>
                <h2 class="text-2xl font-bold text-red-400 mb-4">Game Error</h2>
                <p class="text-lg text-gray-300">Failed to initialize game services. Please contact support.</p>
                <p class="text-md text-gray-400 mt-2">Error: ${error.message}</p>
            `;
            throw error; // Stop further execution
        }

        let userId = null;
        let gameDataRef = null;
        let unsubscribeSnapshot = null; // To store the unsubscribe function for onSnapshot
        let energyRegenInterval = null; // To store the interval ID for energy regen
        let passiveIncomeInterval = null; // To store the interval ID for passive income

        // Game State
        let gameState = {
            coins: 0,
            energy: 1000,
            maxEnergy: 1000,
            energyRegenRate: 1, // energy per second
            coinsPerTap: 1,
            lastDailyRewardClaim: 0, // Unix timestamp in milliseconds
            upgradeLevels: {
                tapPower: 0,
                energyCapacity: 0,
                energyRegen: 0
            },
            hourlyProfit: 0,
            ownedCards: {}, // { cardId: level }
            lastProfitCalculationTime: Date.now(), // Timestamp for passive income calculation
            accumulatedProfit: 0
        };

        // Upgrade Costs and Increments (can be adjusted for game balance)
        const UPGRADE_CONFIG = {
            tapPower: {
                baseCost: 100,
                costMultiplier: 1.5,
                increment: 1
            },
            energyCapacity: {
                baseCost: 200,
                costMultiplier: 1.6,
                increment: 100
            },
            energyRegen: {
                baseCost: 300,
                costMultiplier: 1.7,
                increment: 0.1
            }
        };

        // Card Configurations (Updated to be more like Hamster Kombat categories)
        const CARD_CONFIG = {
            'defi_trading': {
                name: 'DeFi Trading',
                icon: '<i class="fas fa-chart-line"></i>',
                baseCost: 1000,
                costMultiplier: 2.0,
                baseProfitPerHour: 25,
                profitMultiplier: 1.3,
                maxLevel: 10
            },
            'influencer_marketing': {
                name: 'Influencer Marketing',
                icon: '<i class="fas fa-bullhorn"></i>',
                baseCost: 2500,
                costMultiplier: 1.9,
                baseProfitPerHour: 60,
                profitMultiplier: 1.4,
                maxLevel: 8
            },
            'kyc_compliance': {
                name: 'KYC Compliance',
                icon: '<i class="fas fa-user-check"></i>',
                baseCost: 5000,
                costMultiplier: 1.8,
                baseProfitPerHour: 120,
                profitMultiplier: 1.5,
                maxLevel: 7
            },
            'web3_academy': {
                name: 'Web3 Academy',
                icon: '<i class="fas fa-graduation-cap"></i>',
                baseCost: 8000,
                costMultiplier: 1.7,
                baseProfitPerHour: 200,
                profitMultiplier: 1.6,
                maxLevel: 5
            },
            'liquidity_pool': {
                name: 'Liquidity Pool',
                icon: '<i class="fas fa-water"></i>',
                baseCost: 15000,
                costMultiplier: 1.6,
                baseProfitPerHour: 400,
                profitMultiplier: 1.7,
                maxLevel: 4
            },
            'security_audit': {
                name: 'Security Audit',
                icon: '<i class="fas fa-shield-alt"></i>',
                baseCost: 25000,
                costMultiplier: 1.5,
                baseProfitPerHour: 700,
                profitMultiplier: 1.8,
                maxLevel: 3
            }
        };

        /**
         * Displays a temporary message to the user.
         * @param {string} message The message to display.
         * @param {string} type The type of message (e.g., 'success', 'error', 'info').
         */
        function showMessage(message, type = 'info') {
            // Ensure messageBox and messageText are available
            if (!messageBox || !messageText) {
                console.error("showMessage called before messageBox/messageText are initialized:", message);
                return;
            }

            messageText.textContent = message;
            messageBox.className = 'fixed top-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 message-box'; // Reset animation
            messageBox.classList.remove('hidden');

            // Apply type-specific styling
            if (type === 'success') {
                messageBox.classList.add('bg-green-600', 'text-white');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-600', 'text-white');
            } else {
                messageBox.classList.add('bg-gray-800', 'text-white');
            }

            // Re-trigger animation
            void messageBox.offsetWidth; // Trigger reflow to restart animation
            messageBox.classList.add('message-box');

            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000); // Hide after 3 seconds
        }

        /**
         * Calculates the cost of the next level of an upgrade.
         * @param {string} upgradeType The type of upgrade (e.g., 'tapPower').
         * @returns {number} The cost of the next upgrade level.
         */
        function calculateUpgradeCost(upgradeType) {
            const config = UPGRADE_CONFIG[upgradeType];
            const currentLevel = gameState.upgradeLevels[upgradeType];
            return Math.floor(config.baseCost * Math.pow(config.costMultiplier, currentLevel));
        }

        /**
         * Calculates the cost of the next level of a card.
         * @param {string} cardId The ID of the card.
         * @returns {number} The cost of the next card level.
         */
        function calculateCardCost(cardId) {
            const config = CARD_CONFIG[cardId];
            const currentLevel = gameState.ownedCards[cardId] || 0;
            return Math.floor(config.baseCost * Math.pow(config.costMultiplier, currentLevel));
        }

        /**
         * Calculates the profit per hour for a specific card at a given level.
         * @param {string} cardId The ID of the card.
         * @param {number} level The level of the card.
         * @returns {number} The profit per hour for the card.
         */
        function calculateCardProfitPerHour(cardId, level) {
            const config = CARD_CONFIG[cardId];
            // Level 0 means no profit, level 1 is base profit
            return level > 0 ? config.baseProfitPerHour * Math.pow(config.profitMultiplier, level - 1) : 0;
        }

        /**
         * Recalculates the total hourly profit from all owned cards.
         */
        function recalculateHourlyProfit() {
            let totalProfit = 0;
            for (const cardId in gameState.ownedCards) {
                const level = gameState.ownedCards[cardId];
                if (level > 0 && CARD_CONFIG[cardId]) {
                    totalProfit += calculateCardProfitPerHour(cardId, level);
                }
            }
            gameState.hourlyProfit = totalProfit;
        }

        /**
         * Updates the UI elements based on the current game state.
         */
        function updateUI() {
            coinsDisplay.textContent = Math.floor(gameState.coins);
            energyDisplay.textContent = `${Math.floor(gameState.energy)} / ${Math.floor(gameState.maxEnergy)}`;
            energyBarFill.style.width = `${(gameState.energy / gameState.maxEnergy) * 100}%`;

            // Update upgrade section UI
            tapPowerLevel.textContent = `(Lv. ${gameState.upgradeLevels.tapPower})`;
            tapPowerIncrease.textContent = UPGRADE_CONFIG.tapPower.increment;
            tapPowerCost.textContent = calculateUpgradeCost('tapPower');

            energyCapacityLevel.textContent = `(Lv. ${gameState.upgradeLevels.energyCapacity})`;
            energyCapacityIncrease.textContent = UPGRADE_CONFIG.energyCapacity.increment;
            energyCapacityCost.textContent = calculateUpgradeCost('energyCapacity');

            energyRegenLevel.textContent = `(Lv. ${gameState.upgradeLevels.energyRegen})`;
            energyRegenIncrease.textContent = UPGRADE_CONFIG.energyRegen.increment.toFixed(1);
            energyRegenCost.textContent = calculateUpgradeCost('energyRegen');

            // Disable upgrade buttons if not enough coins
            upgradeTapPowerBtn.disabled = gameState.coins < calculateUpgradeCost('tapPower');
            upgradeEnergyCapacityBtn.disabled = gameState.coins < calculateUpgradeCost('energyCapacity');
            upgradeEnergyRegenBtn.disabled = gameState.coins < calculateUpgradeCost('energyRegen');

            // Update mining section UI
            hourlyProfitDisplay.textContent = Math.floor(gameState.hourlyProfit);
            accumulatedProfitDisplay.textContent = Math.floor(gameState.accumulatedProfit);
            claimProfitBtn.disabled = gameState.accumulatedProfit <= 0;

            // Render cards dynamically
            cardsList.innerHTML = ''; // Clear existing cards
            for (const cardId in CARD_CONFIG) {
                const card = CARD_CONFIG[cardId];
                const currentLevel = gameState.ownedCards[cardId] || 0;
                const nextCost = calculateCardCost(cardId);
                const currentProfit = calculateCardProfitPerHour(cardId, currentLevel);
                const nextProfit = calculateCardProfitPerHour(cardId, currentLevel + 1);
                const isMaxLevel = currentLevel >= card.maxLevel;

                const cardElement = document.createElement('div');
                cardElement.classList.add('flex', 'items-center', 'justify-between', 'bg-gray-800', 'p-4', 'rounded-lg', 'shadow-md');
                cardElement.innerHTML = `
                    <div>
                        <h3 class="font-semibold text-lg text-purple-400">${card.icon} ${card.name} <span class="text-gray-400">(Lv. ${currentLevel})</span></h3>
                        <p class="text-sm text-gray-300">Profit/hr: ${Math.floor(currentProfit)} <span class="text-green-400">${isMaxLevel ? '' : `-> ${Math.floor(nextProfit)}`}</span></p>
                    </div>
                    <button id="buy-card-${cardId}" class="btn-primary py-2 px-4 rounded-lg text-sm font-bold ${isMaxLevel ? 'opacity-50 cursor-not-allowed' : ''}" ${isMaxLevel ? 'disabled' : ''}>
                        ${isMaxLevel ? 'Max Level' : `Buy (${nextCost} <i class="fas fa-coins"></i>)`}
                    </button>
                `;
                cardsList.appendChild(cardElement);

                // Add event listener for the buy button
                if (!isMaxLevel) {
                    const buyButton = cardElement.querySelector(`#buy-card-${cardId}`);
                    buyButton.disabled = gameState.coins < nextCost;
                    buyButton.addEventListener('click', () => purchaseCard(cardId));
                }
            }
        }

        /**
         * Saves the current game state to Firestore.
         */
        async function saveGameState() {
            if (gameDataRef) {
                try {
                    // Update lastProfitCalculationTime before saving
                    gameState.lastProfitCalculationTime = Date.now();
                    await setDoc(gameDataRef, gameState);
                    console.log("Game state saved successfully!");
                } catch (error) {
                    console.error("Error saving game state:", error);
                    showMessage("Error saving game progress.", 'error');
                }
            }
        }

        /**
         * Handles the tapping action.
         * @param {Event} event The click/touch event.
         */
        function handleTap(event) {
            if (gameState.energy >= gameState.coinsPerTap) {
                gameState.coins += gameState.coinsPerTap;
                gameState.energy -= gameState.coinsPerTap;
                updateUI();
                saveGameState(); // Save on every tap for responsiveness

                // Show coin popup animation
                const tapRect = tapArea.getBoundingClientRect();
                const x = event.clientX - tapRect.left;
                const y = event.clientY - tapRect.top;

                const coinPopup = document.createElement('div');
                coinPopup.textContent = `+${gameState.coinsPerTap}`;
                coinPopup.classList.add('coin-popup');
                coinPopup.style.left = `${x}px`;
                coinPopup.style.top = `${y}px`;
                tapArea.appendChild(coinPopup);

                coinPopup.addEventListener('animationend', () => {
                    coinPopup.remove();
                });
            } else {
                showMessage("Not enough energy!", 'error');
            }
        }

        /**
         * Handles daily reward claim.
         */
        function claimDailyReward() {
            const now = Date.now();
            const twentyFourHours = 24 * 60 * 60 * 1000; // 24 hours in milliseconds

            if (now - gameState.lastDailyRewardClaim >= twentyFourHours) {
                const rewardAmount = 500; // Example reward
                gameState.coins += rewardAmount;
                gameState.lastDailyRewardClaim = now;
                showMessage(`Claimed daily reward: +${rewardAmount} coins!`, 'success');
                updateUI();
                saveGameState();
            } else {
                const timeRemaining = twentyFourHours - (now - gameState.lastDailyRewardClaim);
                const hours = Math.floor(timeRemaining / (1000 * 60 * 60));
                const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);
                showMessage(`Next daily reward in: ${hours}h ${minutes}m ${seconds}s`, 'info');
            }
        }

        /**
         * Handles upgrade purchases.
         * @param {string} upgradeType The type of upgrade to purchase.
         */
        function purchaseUpgrade(upgradeType) {
            const cost = calculateUpgradeCost(upgradeType);
            const config = UPGRADE_CONFIG[upgradeType];

            if (gameState.coins >= cost) {
                gameState.coins -= cost;
                gameState.upgradeLevels[upgradeType]++;

                if (upgradeType === 'tapPower') {
                    gameState.coinsPerTap += config.increment;
                } else if (upgradeType === 'energyCapacity') {
                    gameState.maxEnergy += config.increment;
                    // Also fill energy to new max when capacity increases
                    gameState.energy = Math.min(gameState.energy + config.increment, gameState.maxEnergy);
                } else if (upgradeType === 'energyRegen') {
                    gameState.energyRegenRate += config.increment;
                }

                showMessage(`${upgradeType.replace(/([A-Z])/g, ' $1')} upgraded to Lv. ${gameState.upgradeLevels[upgradeType]}!`, 'success');
                updateUI();
                saveGameState();
            } else {
                showMessage("Not enough coins for this upgrade!", 'error');
            }
        }

        /**
         * Handles card purchases.
         * @param {string} cardId The ID of the card to purchase.
         */
        function purchaseCard(cardId) {
            const cost = calculateCardCost(cardId);
            const cardConfig = CARD_CONFIG[cardId];
            const currentLevel = gameState.ownedCards[cardId] || 0;

            if (currentLevel >= cardConfig.maxLevel) {
                showMessage(`This card is already at max level (${cardConfig.maxLevel}).`, 'info');
                return;
            }

            if (gameState.coins >= cost) {
                gameState.coins -= cost;
                gameState.ownedCards[cardId] = (gameState.ownedCards[cardId] || 0) + 1;
                recalculateHourlyProfit(); // Recalculate profit after buying a card
                showMessage(`${cardConfig.name} upgraded to Lv. ${gameState.ownedCards[cardId]}!`, 'success');
                updateUI();
                saveGameState();
            } else {
                showMessage("Not enough coins for this card!", 'error');
            }
        }

        /**
         * Updates accumulated profit based on time elapsed.
         */
        function updateAccumulatedProfit() {
            const now = Date.now();
            const timeElapsed = now - gameState.lastProfitCalculationTime; // in milliseconds

            if (timeElapsed > 0 && gameState.hourlyProfit > 0) {
                // Convert hourly profit to profit per millisecond
                const profitPerMs = gameState.hourlyProfit / (60 * 60 * 1000);
                const profitToAdd = profitPerMs * timeElapsed;
                gameState.accumulatedProfit += profitToAdd;
            }
            gameState.lastProfitCalculationTime = now;
            updateUI(); // Update UI to show accumulated profit
        }

        /**
         * Claims all accumulated passive profit.
         */
        function claimAccumulatedProfit() {
            if (gameState.accumulatedProfit > 0) {
                gameState.coins += gameState.accumulatedProfit;
                showMessage(`Claimed ${Math.floor(gameState.accumulatedProfit)} passive coins!`, 'success');
                gameState.accumulatedProfit = 0;
                updateUI();
                saveGameState();
            } else {
                showMessage("No passive profit to claim.", 'info');
            }
        }

        /**
         * Starts the energy regeneration and passive income loops.
         */
        function startGameLoops() {
            if (!energyRegenInterval) {
                energyRegenInterval = setInterval(() => {
                    if (gameState.energy < gameState.maxEnergy) {
                        gameState.energy = Math.min(gameState.maxEnergy, gameState.energy + gameState.energyRegenRate);
                        updateUI();
                    }
                }, 1000); // Regenerate every second
            }

            if (!passiveIncomeInterval) {
                passiveIncomeInterval = setInterval(() => {
                    updateAccumulatedProfit();
                }, 1000); // Check and update accumulated profit every second
            }
        }

        /**
         * Stops the energy regeneration and passive income loops.
         */
        function stopGameLoops() {
            if (energyRegenInterval) {
                clearInterval(energyRegenInterval);
                energyRegenInterval = null;
            }
            if (passiveIncomeInterval) {
                clearInterval(passiveIncomeInterval);
                passiveIncomeInterval = null;
            }
        }

        /**
         * Loads game data for a given user ID.
         * @param {string} id The user ID to load data for.
         */
        async function loadGameData(id) {
            console.log(`Attempting to load game data for userId: ${id}`);
            userId = id;
            userIdDisplay.textContent = userId;
            gameDataRef = doc(db, `artifacts/${appId}/users/${userId}/hamster_coin_game`, 'game_state');

            stopGameLoops();
            if (unsubscribeSnapshot) {
                unsubscribeSnapshot();
                unsubscribeSnapshot = null;
            }

            try {
                unsubscribeSnapshot = onSnapshot(gameDataRef, (docSnap) => {
                    console.log("Firestore onSnapshot callback fired.");
                    if (docSnap.exists()) {
                        const loadedState = docSnap.data();
                        gameState = {
                            ...gameState,
                            ...loadedState,
                            upgradeLevels: { ...gameState.upgradeLevels, ...(loadedState.upgradeLevels || {}) },
                            ownedCards: { ...gameState.ownedCards, ...(loadedState.ownedCards || {}) }
                        };
                        console.log("Game state loaded/updated from Firestore:", gameState);

                        const now = Date.now(); // Corrected from Date.2025()
                        const timeElapsedOffline = now - (gameState.lastProfitCalculationTime || now);
                        if (timeElapsedOffline > 0 && gameState.hourlyProfit > 0) {
                            const profitPerMs = gameState.hourlyProfit / (60 * 60 * 1000);
                            const offlineProfit = profitPerMs * timeElapsedOffline;
                            gameState.accumulatedProfit += offlineProfit;
                            showMessage(`Welcome back! You earned ${Math.floor(offlineProfit)} coins while away.`, 'info');
                        }
                        gameState.lastProfitCalculationTime = now;
                    } else {
                        console.log("No game state found in Firestore, initializing new game state.");
                        gameState.lastProfitCalculationTime = Date.now();
                        setDoc(gameDataRef, gameState)
                            .then(() => console.log("Initial game state set successfully."))
                            .catch(error => console.error("Error setting initial game state:", error));
                    }
                    recalculateHourlyProfit();
                    updateUI();
                    gameSection.classList.remove('hidden'); // Show game
                    telegramOnlyMessage.classList.add('hidden'); // Hide message
                    loadingOverlay.classList.add('hidden'); // Hide loading overlay
                    startGameLoops(); // Start game loops only after data is ready
                    console.log("Game loaded and UI updated.");
                }, (error) => {
                    console.error("Error listening to game state (onSnapshot error callback):", error);
                    showMessage("Error loading game data. Please check your internet connection and Firebase rules.", 'error');
                    loadingOverlay.classList.add('hidden'); // Hide loading overlay
                    // Show generic error message if data loading fails
                    telegramOnlyMessage.classList.remove('hidden');
                    document.getElementById('telegram-only-message').innerHTML = `
                        <i class="fas fa-exclamation-triangle text-6xl text-red-400 mb-4"></i>
                        <h2 class="text-2xl font-bold text-red-400 mb-4">Data Loading Error</h2>
                        <p class="text-lg text-gray-300">Could not load your game data. This might be a network issue or Firebase security rules preventing access.</p>
                        <p class="text-md text-gray-400 mt-2">Error: ${error.message}</p>
                    `;
                });
            } catch (error) {
                console.error("Error setting up Firestore listener (try-catch block):", error);
                showMessage("Failed to set up game data listener. Please try again.", 'error');
                loadingOverlay.classList.add('hidden'); // Hide loading overlay
                telegramOnlyMessage.classList.remove('hidden');
                document.getElementById('telegram-only-message').innerHTML = `
                    <i class="fas fa-exclamation-triangle text-6xl text-red-400 mb-4"></i>
                    <h2 class="text-2xl font-bold text-red-400 mb-4">Game Setup Error</h2>
                    <p class="text-lg text-gray-300">An error occurred during game setup. Please try again later.</p>
                    <p class="text-md text-gray-400 mt-2">Error: ${error.message}</p>
                `;
            }
        }

        // Event Listeners for Game
        tapArea.addEventListener('click', handleTap);
        dailyRewardBtn.addEventListener('click', claimDailyReward);

        upgradesBtn.addEventListener('click', () => {
            upgradesSection.classList.remove('hidden');
            miningSection.classList.add('hidden');
        });
        closeUpgradesBtn.addEventListener('click', () => {
            upgradesSection.classList.add('hidden');
        });

        miningBtn.addEventListener('click', () => {
            miningSection.classList.remove('hidden');
            upgradesSection.classList.add('hidden');
            updateUI();
        });
        closeMiningBtn.addEventListener('click', () => {
            miningSection.classList.add('hidden');
        });

        claimProfitBtn.addEventListener('click', claimAccumulatedProfit);

        upgradeTapPowerBtn.addEventListener('click', () => purchaseUpgrade('tapPower'));
        upgradeEnergyCapacityBtn.addEventListener('click', () => purchaseUpgrade('energyCapacity'));
        upgradeEnergyRegenBtn.addEventListener('click', () => purchaseUpgrade('energyRegen'));

        // Initial check for Telegram Web App on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded fired. Initializing...");
            loadingOverlay.classList.remove('hidden'); // Always show loading initially

            // Check if Telegram WebApp object is available and has user data
            if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                console.log("Telegram WebApp detected. Attempting to get user ID.");
                // Ensure user.id exists before trying to access it
                if (window.Telegram.WebApp.initDataUnsafe.user.id) {
                    const telegramUserId = `telegram_${window.Telegram.WebApp.initDataUnsafe.user.id}`;
                    console.log(`Telegram User ID obtained: ${telegramUserId}. Calling loadGameData.`);
                    loadGameData(telegramUserId);
                } else {
                    console.error("Telegram WebApp detected, but user.id is undefined. Cannot load game data.");
                    loadingOverlay.classList.add('hidden');
                    gameSection.classList.add('hidden');
                    telegramOnlyMessage.classList.remove('hidden');
                    document.getElementById('telegram-only-message').innerHTML = `
                        <i class="fas fa-exclamation-triangle text-6xl text-red-400 mb-4"></i>
                        <h2 class="text-2xl font-bold text-red-400 mb-4">Telegram User Error</h2>
                        <p class="text-lg text-gray-300">Could not retrieve your Telegram User ID. Please ensure you are logged into Telegram.</p>
                        <p class="text-md text-gray-400 mt-2">If the issue persists, try restarting Telegram or your device.</p>
                    `;
                }
            } else {
                console.warn("Not in Telegram WebApp or user data not available. Displaying restriction message.");
                // Not in Telegram WebApp, show message and hide game
                loadingOverlay.classList.add('hidden');
                gameSection.classList.add('hidden');
                telegramOnlyMessage.classList.remove('hidden');
            }
        });

        // Cleanup on window unload (optional, but good practice for real-time listeners)
        window.addEventListener('beforeunload', () => {
            if (unsubscribeSnapshot) {
                unsubscribeSnapshot();
                console.log("Firestore listener unsubscribed on unload.");
            }
            stopGameLoops();
            console.log("Game loops stopped on unload.");
        });
    </script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</body>
</html>
